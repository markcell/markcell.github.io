/*!
 * Tabledit v1.1.0 (https://github.com/markcell/jQuery-Tabledit)
 * Copyright (c) 2015 Celso Marques
 * Licensed under MIT (https://github.com/markcell/jQuery-Tabledit/blob/master/LICENSE)
 */
if(typeof jQuery==='undefined'){throw new Error('Tabledit requires jQuery library.');}(function($){'use strict';var defaults={url:window.location.href,inputClass:'form-control input-sm',dangerClass:'danger',warningClass:'warning',mutedClass:'text-muted',eventType:'click',confirmText:' &nbsp; Confirm',hideIdentifier:false,textSelection:true,editButton:true,removeButton:true,buttons:{edit:{class:'btn btn-sm btn-warning',html:'<span class="glyphicon glyphicon-pencil"></span>'},remove:{class:'btn btn-sm btn-danger',html:'<span class="glyphicon glyphicon-trash"></span>'},save:{class:'btn btn-sm btn-success',html:'<span class="glyphicon glyphicon-ok"></span> &nbsp; Save'},cancel:{class:'btn btn-sm btn-warning',html:'<span class="glyphicon glyphicon-pencil"></span>'}},onDraw:function(){return;},onSuccess:function(){return;},onFail:function(){return;},onAlways:function(){return;}};var settings={};var $table='undefined';var $lastEditedRow='undefined';var $lastRemovedRow='undefined';var Draw={form:function(url){if(!$table.parent('form.tabledit-form').length>0){$table.wrap('<form action="'+url+'" method="post" class="tabledit-form"></form>');}},columns:{identifier:function(){if(settings.hideIdentifier){$table.find('th:nth-child('+parseInt(settings.columns.identifier[0])+1+'), td:nth-child('+parseInt(settings.columns.identifier[0])+1+')').hide();}var $td=$table.find('td:nth-child('+(parseInt(settings.columns.identifier[0])+1)+')');$td.each(function(){var span='<span class="tabledit-span tabledit-identifier">'+$(this).text()+'</span>';var input='<input class="tabledit-input tabledit-identifier" type="hidden" name="'+settings.columns.identifier[1]+'" value="'+$(this).text()+'" disabled>';$(this).html(span+input);$(this).parent('tr').attr('id',$(this).text());});},editable:function(){for(var i=0;i<settings.columns.editable.length;i++){var $td=$table.find('td:nth-child('+(parseInt(settings.columns.editable[i][0])+1)+')');$td.each(function(){if(!settings.editButton){$(this).css('cursor','pointer');}var span='<span class="tabledit-span">'+$(this).text()+'</span>';if(typeof settings.columns.editable[i][2]!=='undefined'){var input='<select class="tabledit-input '+settings.inputClass+'" name="'+settings.columns.editable[i][1]+'" style="display: none;" disabled>';$.each(jQuery.parseJSON(settings.columns.editable[i][2]),function(index,value){input+='<option value="'+index+'">'+value+'</option>';});input+='</select>';}else{var input='<input class="tabledit-input '+settings.inputClass+'" type="text" name="'+settings.columns.editable[i][1]+'" value="'+$(this).text()+'" style="display: none;" disabled>';}$(this).html(span+input);$(this).addClass('tabledit-view-mode');});}if(!settings.textSelection){$table.find('td.tabledit-view-mode').css('-webkit-touch-callout','none').css('-webkit-user-select','none').css('-khtml-user-select','none').css('-moz-user-select','none').css('-ms-user-select','none').css('user-select','none');}},toolbox:function(){if(settings.editButton||settings.removeButton){var editButton='';var removeButton='';var saveButton='';var cancelButton='';if($table.find('th.tabledit-toolbox-column').length===0){$table.find('tr:first').append('<th class="tabledit-toolbox-column"></th>');}if((settings.buttons.edit.class===settings.buttons.cancel.class)&&(settings.buttons.edit.text===settings.buttons.cancel.text)){settings.buttons.cancel.class+=' active';}if(settings.editButton){editButton='<button type="button" class="tabledit-edit-button '+settings.buttons.edit.class+'" style="margin-left: 5px;">'+settings.buttons.edit.html+'</button>';saveButton='<button type="button" class="tabledit-save-button '+settings.buttons.save.class+'" style="margin-left: 5px; display: none;">'+settings.buttons.save.html+'</button>';cancelButton='<button type="button" class="tabledit-cancel-button '+settings.buttons.cancel.class+'" style="margin-left: 5px; display: none;">'+settings.buttons.cancel.html+'</button>';}if(settings.removeButton){removeButton='<button type="button" class="tabledit-remove-button '+settings.buttons.remove.class+'" style="margin-left: 5px;">'+settings.buttons.remove.html+'</button>';}$table.find('tr:gt(0)').append('<td style="white-space: nowrap; width: 1px;"><div class="tabledit-toolbox" style="margin-left: -5px; text-align: right;">'+editButton+saveButton+cancelButton+removeButton+'</div></td>');}}}};var Mode={view:function(td){var $tr=$(td).parent('tr');$(td).parent('tr').find('.tabledit-input.tabledit-identifier').prop('disabled',true);$(td).find('.tabledit-input').blur().hide().prop('disabled',true);$(td).find('.tabledit-span').show();$(td).addClass('tabledit-view-mode').removeClass('tabledit-edit-mode');if(settings.editButton){$tr.find('button.tabledit-save-button, button.tabledit-cancel-button').hide();$tr.find('button.tabledit-edit-button').show();}},edit:function(td){Remove.reset();var $tr=$(td).parent('tr');$tr.find('.tabledit-input.tabledit-identifier').prop('disabled',false);$(td).find('.tabledit-span').hide();$(td).find('.tabledit-input').prop('disabled',false).show().focus();$(td).addClass('tabledit-edit-mode').removeClass('tabledit-view-mode');if(settings.editButton){$tr.find('button.tabledit-edit-button').hide();$tr.find('button.tabledit-save-button, button.tabledit-cancel-button').show();}}};var Edit={reset:function(td){$(td).each(function(){var $input=$(this).find('.tabledit-input');if($input.is('select')){$input.find('option[text="'+$(this).find('.tabledit-span').text()+'"]').attr('selected',true);}else{$input.val($(this).find('.tabledit-span').text());}Mode.view(this);});},submit:function(td){ajax('edit');$(td).each(function(){var $input=$(this).find('.tabledit-input');if($input.is('select')){$(this).find('.tabledit-span').text($input.find('option:selected').text());}else{$(this).find('.tabledit-span').text($input.val());}Mode.view(this);});$lastEditedRow=$(td).parent('tr');}};var Remove={reset:function(){$table.find('.tabledit-remove-button.tabledit-confirm').removeClass('tabledit-confirm').find('span.tabledit-confirm-text').remove();},submit:function(button){Remove.reset();$(button).parents('tr').find('input.tabledit-identifier').attr('disabled',false);ajax('remove');$(button).parents('tr').addClass(settings.mutedClass).find('.tabledit-toolbox button').attr('disabled',true);$(button).parents('tr').find('input.tabledit-identifier').attr('disabled',true);$lastRemovedRow=$(button).parents('tr');},confirm:function(button){Mode.view($(button).parents('tr').find('td.tabledit-edit-mode'));$(button).html(settings.buttons.remove.html+'<span class="tabledit-confirm-text">'+settings.confirmText+'</span>').addClass('tabledit-confirm').blur();}};function ajax(action){var data='&action='+action;var jqXHR=$.post(settings.url,$('form.tabledit-form').serialize()+data,function(data,textStatus,jqXHR){if(action==='edit'){$lastEditedRow.removeClass(settings.dangerClass).addClass(settings.warningClass);setTimeout(function(){$lastEditedRow.removeClass(settings.warningClass);},1400);}settings.onSuccess(data,textStatus,jqXHR);},'json');jqXHR.fail(function(jqXHR,textStatus,errorThrown){if(action==='remove'){$lastRemovedRow.addClass(settings.dangerClass).show();}else if(action==='edit'){$lastEditedRow.addClass(settings.dangerClass);}settings.onFail(jqXHR,textStatus,errorThrown);});jqXHR.always(function(){settings.onAlways();});return jqXHR;}$.fn.Tabledit=function(options){if(!this.is('table')){throw new Error('Tabledit only works when applied to a table.');}$table=this;settings=$.extend({},defaults,options);Draw.form(settings.url);Draw.columns.identifier();Draw.columns.editable();Draw.columns.toolbox();settings.onDraw();if(settings.removeButton){$table.on('click','button.tabledit-remove-button',function(event){if(event.handled!==true){event.preventDefault();if($(this).hasClass('tabledit-confirm')){Remove.submit(this);}else{Remove.reset();Remove.confirm(this);}event.handled=true;}});}if(settings.editButton){$table.on('click','button.tabledit-edit-button',function(event){if(event.handled!==true){event.preventDefault();Edit.reset($table.find('td.tabledit-edit-mode'));$($(this).parents('tr').find('td.tabledit-view-mode').get().reverse()).each(function(){Mode.edit(this);});event.handled=true;}});$table.on('click','button.tabledit-save-button',function(event){if(event.handled!==true){event.preventDefault();Edit.submit($(this).parents('tr').find('td.tabledit-edit-mode'));event.handled=true;}});$table.on('click','button.tabledit-cancel-button',function(event){if(event.handled!==true){event.preventDefault();Edit.reset($(this).parents('tr').find('td.tabledit-edit-mode'));event.handled=true;}});}else{$table.on(settings.eventType,'td.tabledit-view-mode',function(event){if(event.handled!==true){event.preventDefault();Edit.reset($table.find('td.tabledit-edit-mode'));Mode.edit(this);event.handled=true;}});$table.on('change','select.tabledit-input:visible',function(){if(event.handled!==true){Edit.submit($(this).parent('td'));event.handled=true;}});$(document).on('click',function(event){var $editMode=$table.find('.tabledit-edit-mode');if(!$editMode.is(event.target)&&$editMode.has(event.target).length===0){Edit.reset($table.find('.tabledit-input:visible').parent('td'));}});}$(document).on('keyup',function(event){var $input=$table.find('.tabledit-input:focus');var $button=$table.find('.tabledit-remove-button.tabledit-confirm');if($input.length>0||$button.length>0){if(settings.editButton){var $td=$input.parents('tr').find('.tabledit-edit-mode');}else{var $td=$input.parent('.tabledit-edit-mode');}switch(event.keyCode){case 13:Edit.submit($td);break;case 27:Edit.reset($td);Remove.reset();break;}}});return this;};}(jQuery));